# CSSカスケード順序の罠 — 4000行の単一CSSファイルで学んだ教訓

ポートフォリオサイトのモバイル表示が崩壊した原因は、CSSの「カスケード順序」という初歩的だが見落としやすい仕組みにありました。この記事では、4000行超の単一CSSファイルで発生した実際のバグと、その根本原因分析（RCA）、そして再発防止策を解説します。

## 何が起きたのか

トップページの Bento Grid カード（Projects / Blog / Let's Connect）がモバイル表示で潰れていました。各カードは `grid-column: span 4`（3列並び）のままで、モバイルでフル幅の `span 12` になっていない状態です。

```css
/* 期待: モバイルではフル幅 */
.home-nav-card--projects,
.home-nav-card--blog,
.home-nav-card--connect {
  grid-column: span 12; /* ← これが効いていない */
}
```

## 原因: カスケード順序

CSSには「**同じ詳細度のルールは、後に書かれた方が勝つ**」というカスケード規則があります。

`styles.css` の構造を調べると、こうなっていました:

```
行 1762: @media (max-width: 768px) {
           .home-nav-card--projects { grid-column: span 12; }  ← モバイル用
         }

行 3302: .home-nav-card--projects { grid-column: span 4; }     ← ベーススタイル
```

**ベーススタイル（3302行目）がメディアクエリ（1762行目）より後方に定義**されているため、同じ詳細度ではカスケード順序でベーススタイルが勝ちます。メディアクエリの条件が `true` でも、後に書かれた `span 4` が最終的に適用されます。

## なぜ起きたのか

このプロジェクトの `styles.css` は**4000行超の単一ファイル**です。開発の経緯で以下のような構造になっていました:

1. **初期実装**（〜1800行付近）: レイアウト + メディアクエリをセットで記述
2. **デザインリニューアル**（〜3300行付近）: 新しいナビカードのスタイルを追加

リニューアル時に追加されたベーススタイルが、既存のメディアクエリより**ファイルの後方**に配置されたことで、モバイル用ルールが無効化されました。

## 修正方法

コンポーネントのベーススタイルの**直後**にメディアクエリを配置しました:

```css
/* ベーススタイル */
.home-nav-card--projects { grid-column: span 4; }
.home-nav-card--blog     { grid-column: span 4; }
.home-nav-card--connect  { grid-column: span 4; }

/* ↓ 直後にモバイル対応を記述（分散配置禁止） */
@media (max-width: 768px) {
  .home-nav-card--projects,
  .home-nav-card--blog,
  .home-nav-card--connect {
    grid-column: span 12;
  }
}
```

## 再発防止: 3つのルール

この経験から、以下の3つのルールを `copilot-instructions.md` に追加しました:

### 1. カスケード順序の確認

変更対象セレクタに既存のメディアクエリがある場合、新しいベーススタイルがそのメディアクエリより**後方**に記述されていないか確認する。

### 2. grep で既存ルールを全件確認

```bash
grep -n "home-nav-card" styles.css
```

同一セレクタを変更・追加する前に、全出現箇所を確認し、メディアクエリ内の定義との競合がないか検証する。

### 3. コンポーネント＋レスポンシブはセットで記述

新規コンポーネントのベーススタイルとモバイル用オーバーライドは**隣接して記述**する。ファイル内の離れた場所にあるメディアクエリブロックに追記しない。

## 教訓

| 観点 | 学び |
|------|------|
| CSS設計 | 単一ファイル構成では、カスケード順序が最大のリスク |
| 開発プロセス | 新しいスタイル追加前に `grep` で既存定義を全件確認する |
| ドキュメント | 構造的リスクはプロンプト/ガイドラインに明記して自動化する |
| テスト | CSSの変更後は必ずモバイル（375px）で目視確認する |

## まとめ

CSSカスケード順序は基本中の基本ですが、ファイルが大きくなると見落としやすい罠になります。特に**単一CSSファイル**で運用している場合、コンポーネントの追加順序がそのままカスケード順序になるため、「コンポーネント + レスポンシブをセットで書く」というルールを厳守することが重要です。

フレームワークを使わない Vanilla CSS だからこそ、こうした基礎知識が直接バグの原因になり、同時に直接的な解決策にもなります。
