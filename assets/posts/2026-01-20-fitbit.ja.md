# UCFitness開発ログ: Fitbit APIの「Rate Limit」との戦い

## はじめに

個人プロジェクトとして開発中のフィットネストラッカー **「UCFitness」** は、Fitbitのウェアラブルデバイスから取得した歩数・心拍数・消費カロリーなどのデータを集約し、ユーザー間のランキングを表示するWebアプリケーションです。技術スタックには **Next.js（App Router）**、**Supabase**、**Tailwind CSS** を採用しています。

この記事では、開発中に直面した最大の技術的課題である **Fitbit Web APIのRate Limit（利用制限）** と、その解決に至るまでのアーキテクチャ設計について詳しく記録します。

## 問題: Fitbit APIのRate Limit

Fitbit Web APIには、**1ユーザーあたり1時間に150リクエスト** という明確なRate Limitが設けられています。一見すると十分な数に思えますが、UCFitnessのようなアプリでは以下の理由から簡単に上限に達してしまいます。

- **複数エンドポイントへのアクセス**: 歩数、心拍数、消費カロリー、睡眠データなど、1ユーザーの情報取得だけで4〜6リクエストが必要
- **日付範囲の指定**: 週間・月間データの取得には日付ごとのリクエストが必要なケースがある
- **複数ユーザーの同時アクセス**: ランキング機能では全参加者のデータを最新に保つ必要がある
- **フロントエンドからの再リクエスト**: ページ遷移やリロードのたびにAPIを叩く設計では、すぐに上限に到達する

特に問題だったのは、**ユーザーがページを開くたびに直接Fitbit APIを呼び出す設計** にしていた初期実装です。10人のユーザーが同時にアクセスするだけで、1時間の制限にかなり近づいてしまう状況でした。

## 解決策: バッチ取得 + キャッシュアーキテクチャ

この問題を根本的に解決するため、以下の3層アーキテクチャを設計しました。

### 1. Next.js API Routes（サーバーサイド処理）

フロントエンドから直接Fitbit APIを呼ぶのではなく、**Next.jsのAPI Routes** をプロキシとして間に挟みました。これにより：

- APIキーやアクセストークンをサーバーサイドで安全に管理できる
- リクエストの頻度をサーバー側で制御できる
- エラーハンドリングを一元化できる

### 2. Supabaseによるデータキャッシュ

Fitbit APIから取得したデータを **Supabase（PostgreSQL）** に保存し、フロントエンドからはキャッシュされたデータを参照する仕組みにしました。

- データの鮮度は `updated_at` カラムで管理
- 一定期間（例: 15分）以内のデータはキャッシュから返却
- キャッシュミス時のみFitbit APIにリクエストを送信

### 3. バックグラウンドバッチ処理

最も効果的だったのが、**定期的なバッチ処理** の導入です。Vercelのサーバーレス環境を活用し、一定間隔で全ユーザーのデータを一括取得してSupabaseに保存します。

- ユーザーのページアクセスとAPI呼び出しを完全に分離
- Rate Limitを計算的に制御可能（ユーザー数 × エンドポイント数 ÷ 時間で配分）
- フロントエンドのレスポンス速度が大幅に向上（API待ちがなくなる）

## 結果と効果

このアーキテクチャ変更により、以下の改善を達成しました。

| 指標 | 変更前 | 変更後 |
|------|--------|--------|
| ページ表示速度 | 2〜3秒（API応答待ち） | 200ms以下（キャッシュ参照） |
| Rate Limit到達 | 頻繁に発生 | ほぼゼロ |
| APIリクエスト効率 | ユーザー×アクセス回数 | 1日数回のバッチのみ |

## 学んだこと

外部APIに依存するアプリケーション開発では、**API制限を前提としたアーキテクチャ設計** が重要です。「まず動くものを作り、後から最適化する」アプローチも有効ですが、Rate Limitのような**ハードな制約**は早い段階で設計に組み込むべきだと実感しました。

また、Supabaseのリアルタイムサブスクリプション機能を活用すれば、バッチ更新されたデータをフロントエンドに即座に反映できるため、ユーザー体験を損なうことなくAPI呼び出しを最小限に抑えられます。

今後は、Fitbit APIがWebhook対応を拡充した場合に備え、**プッシュベースのデータ更新** への移行も視野に入れて開発を続けていきます。
